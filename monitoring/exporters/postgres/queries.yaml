# PostgreSQL Custom Queries for Business Metrics
# AI Finance Agency specific database monitoring

pg_replication:
  query: "SELECT CASE WHEN NOT pg_is_in_recovery() THEN 0 ELSE GREATEST (0, EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()))) END AS lag"
  master: true
  metrics:
    - lag:
        usage: "GAUGE"
        description: "Replication lag behind master in seconds"

pg_postmaster:
  query: "SELECT pg_postmaster_start_time as start_time_seconds from pg_postmaster_start_time()"
  master: true
  metrics:
    - start_time_seconds:
        usage: "GAUGE"
        description: "Time at which postmaster started"

pg_stat_user_tables:
  query: |
    SELECT
      current_database() datname,
      schemaname,
      tablename,
      seq_scan,
      seq_tup_read,
      idx_scan,
      idx_tup_fetch,
      n_tup_ins,
      n_tup_upd,
      n_tup_del,
      n_tup_hot_upd,
      n_live_tup,
      n_dead_tup,
      n_mod_since_analyze,
      COALESCE(last_vacuum, '1970-01-01Z') as last_vacuum,
      COALESCE(last_autovacuum, '1970-01-01Z') as last_autovacuum,
      COALESCE(last_analyze, '1970-01-01Z') as last_analyze,
      COALESCE(last_autoanalyze, '1970-01-01Z') as last_autoanalyze,
      vacuum_count,
      autovacuum_count,
      analyze_count,
      autoanalyze_count
    FROM pg_stat_user_tables
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of current database"
    - schemaname:
        usage: "LABEL"
        description: "Name of the schema that this table is in"
    - tablename:
        usage: "LABEL"
        description: "Name of this table"
    - seq_scan:
        usage: "COUNTER"
        description: "Number of sequential scans initiated on this table"
    - seq_tup_read:
        usage: "COUNTER"
        description: "Number of live rows fetched by sequential scans"
    - idx_scan:
        usage: "COUNTER"
        description: "Number of index scans initiated on this table"
    - idx_tup_fetch:
        usage: "COUNTER"
        description: "Number of live rows fetched by index scans"
    - n_tup_ins:
        usage: "COUNTER"
        description: "Number of rows inserted"
    - n_tup_upd:
        usage: "COUNTER"
        description: "Number of rows updated"
    - n_tup_del:
        usage: "COUNTER"
        description: "Number of rows deleted"
    - n_tup_hot_upd:
        usage: "COUNTER"
        description: "Number of rows HOT updated"
    - n_live_tup:
        usage: "GAUGE"
        description: "Estimated number of live rows"
    - n_dead_tup:
        usage: "GAUGE"
        description: "Estimated number of dead rows"
    - n_mod_since_analyze:
        usage: "GAUGE"
        description: "Estimated number of rows changed since last analyze"
    - last_vacuum:
        usage: "GAUGE"
        description: "Last time at which this table was manually vacuumed"
    - last_autovacuum:
        usage: "GAUGE"
        description: "Last time at which this table was vacuumed by the autovacuum daemon"
    - last_analyze:
        usage: "GAUGE"
        description: "Last time at which this table was manually analyzed"
    - last_autoanalyze:
        usage: "GAUGE"
        description: "Last time at which this table was analyzed by the autovacuum daemon"
    - vacuum_count:
        usage: "COUNTER"
        description: "Number of times this table has been manually vacuumed"
    - autovacuum_count:
        usage: "COUNTER"
        description: "Number of times this table has been vacuumed by the autovacuum daemon"
    - analyze_count:
        usage: "COUNTER"
        description: "Number of times this table has been manually analyzed"
    - autoanalyze_count:
        usage: "COUNTER"
        description: "Number of times this table has been analyzed by the autovacuum daemon"

pg_statio_user_tables:
  query: "SELECT current_database() datname, schemaname, tablename, heap_blks_read, heap_blks_hit, idx_blks_read, idx_blks_hit, toast_blks_read, toast_blks_hit, tidx_blks_read, tidx_blks_hit FROM pg_statio_user_tables"
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of current database"
    - schemaname:
        usage: "LABEL"
        description: "Name of the schema that this table is in"
    - tablename:
        usage: "LABEL"
        description: "Name of this table"
    - heap_blks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read from this table"
    - heap_blks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits in this table"
    - idx_blks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read from all indexes on this table"
    - idx_blks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits in all indexes on this table"
    - toast_blks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read from this table's TOAST table"
    - toast_blks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits in this table's TOAST table"
    - tidx_blks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read from this table's TOAST table indexes"
    - tidx_blks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits in this table's TOAST table indexes"

# Business-specific queries for AI Finance Agency
pg_payment_transactions:
  query: |
    SELECT 
      COUNT(*) as total_transactions,
      COUNT(*) FILTER (WHERE status = 'completed') as completed_transactions,
      COUNT(*) FILTER (WHERE status = 'failed') as failed_transactions,
      COUNT(*) FILTER (WHERE status = 'pending') as pending_transactions,
      COALESCE(SUM(amount) FILTER (WHERE status = 'completed'), 0) as total_revenue
    FROM payments 
    WHERE created_at >= NOW() - INTERVAL '1 hour'
  master: true
  metrics:
    - total_transactions:
        usage: "GAUGE"
        description: "Total payment transactions in last hour"
    - completed_transactions:
        usage: "GAUGE"
        description: "Completed payment transactions in last hour"
    - failed_transactions:
        usage: "GAUGE"
        description: "Failed payment transactions in last hour"
    - pending_transactions:
        usage: "GAUGE"
        description: "Pending payment transactions in last hour"
    - total_revenue:
        usage: "GAUGE"
        description: "Total revenue from completed transactions in last hour"

pg_trading_activity:
  query: |
    SELECT 
      COUNT(*) as total_trades,
      COUNT(*) FILTER (WHERE status = 'executed') as executed_trades,
      COUNT(*) FILTER (WHERE status = 'failed') as failed_trades,
      COALESCE(SUM(volume), 0) as total_volume,
      COALESCE(AVG(execution_time_ms), 0) as avg_execution_time
    FROM trades 
    WHERE created_at >= NOW() - INTERVAL '1 hour'
  master: true
  metrics:
    - total_trades:
        usage: "GAUGE"
        description: "Total trades in last hour"
    - executed_trades:
        usage: "GAUGE"
        description: "Successfully executed trades in last hour"
    - failed_trades:
        usage: "GAUGE"
        description: "Failed trades in last hour"
    - total_volume:
        usage: "GAUGE"
        description: "Total trading volume in last hour"
    - avg_execution_time:
        usage: "GAUGE"
        description: "Average trade execution time in milliseconds"

pg_user_activity:
  query: |
    SELECT 
      COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '1 hour') as new_users_1h,
      COUNT(*) FILTER (WHERE last_login >= NOW() - INTERVAL '1 hour') as active_users_1h,
      COUNT(*) FILTER (WHERE last_login >= NOW() - INTERVAL '24 hours') as active_users_24h,
      COUNT(*) as total_users
    FROM users
  master: true
  metrics:
    - new_users_1h:
        usage: "GAUGE"
        description: "New user registrations in last hour"
    - active_users_1h:
        usage: "GAUGE"
        description: "Active users in last hour"
    - active_users_24h:
        usage: "GAUGE"
        description: "Active users in last 24 hours"
    - total_users:
        usage: "GAUGE"
        description: "Total registered users"

pg_signals_quality:
  query: |
    SELECT 
      COUNT(*) as total_signals,
      COUNT(*) FILTER (WHERE accuracy_score >= 0.8) as high_accuracy_signals,
      COALESCE(AVG(accuracy_score), 0) as avg_accuracy,
      COUNT(*) FILTER (WHERE generated_at >= NOW() - INTERVAL '1 hour') as signals_1h
    FROM trading_signals 
    WHERE generated_at >= NOW() - INTERVAL '24 hours'
  master: true
  metrics:
    - total_signals:
        usage: "GAUGE"
        description: "Total trading signals in last 24 hours"
    - high_accuracy_signals:
        usage: "GAUGE"
        description: "High accuracy signals (>80%) in last 24 hours"
    - avg_accuracy:
        usage: "GAUGE"
        description: "Average signal accuracy in last 24 hours"
    - signals_1h:
        usage: "GAUGE"
        description: "Signals generated in last hour"

pg_database_health:
  query: |
    SELECT 
      (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') as max_connections,
      (SELECT count(*) FROM pg_stat_activity) as active_connections,
      (SELECT count(*) FROM pg_stat_activity WHERE state = 'active') as running_queries,
      (SELECT count(*) FROM pg_stat_activity WHERE state = 'idle in transaction') as idle_in_transaction,
      (SELECT EXTRACT(EPOCH FROM MAX(now() - query_start)) FROM pg_stat_activity WHERE state = 'active') as longest_query_seconds
  master: true
  metrics:
    - max_connections:
        usage: "GAUGE"
        description: "Maximum number of connections allowed"
    - active_connections:
        usage: "GAUGE"
        description: "Current number of active connections"
    - running_queries:
        usage: "GAUGE"
        description: "Number of currently running queries"
    - idle_in_transaction:
        usage: "GAUGE"
        description: "Number of idle in transaction connections"
    - longest_query_seconds:
        usage: "GAUGE"
        description: "Duration of longest running query in seconds"