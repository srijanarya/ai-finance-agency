syntax = "proto3";

package treum.payment;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/struct.proto";

service PaymentService {
  rpc CreatePayment(CreatePaymentRequest) returns (PaymentResponse);
  rpc GetPayment(GetPaymentRequest) returns (PaymentResponse);
  rpc ListPayments(ListPaymentsRequest) returns (ListPaymentsResponse);
  rpc ProcessPayment(ProcessPaymentRequest) returns (PaymentResponse);
  rpc RefundPayment(RefundPaymentRequest) returns (PaymentResponse);
  rpc CreateSubscription(CreateSubscriptionRequest) returns (SubscriptionResponse);
  rpc GetSubscription(GetSubscriptionRequest) returns (SubscriptionResponse);
  rpc UpdateSubscription(UpdateSubscriptionRequest) returns (SubscriptionResponse);
  rpc CancelSubscription(CancelSubscriptionRequest) returns (SubscriptionResponse);
  rpc ListSubscriptions(ListSubscriptionsRequest) returns (ListSubscriptionsResponse);
  rpc ValidatePaymentMethod(ValidatePaymentMethodRequest) returns (ValidatePaymentMethodResponse);
}

// Messages
message CreatePaymentRequest {
  string user_id = 1;
  double amount = 2;
  string currency = 3;
  PaymentMethod method = 4;
  string description = 5;
  string subscription_id = 6;
  google.protobuf.Struct metadata = 7;
}

message ProcessPaymentRequest {
  string payment_id = 1;
  string payment_method_token = 2;
  google.protobuf.Struct payment_details = 3;
}

message GetPaymentRequest {
  string id = 1;
}

message RefundPaymentRequest {
  string payment_id = 1;
  double amount = 2;
  string reason = 3;
}

message ListPaymentsRequest {
  string user_id = 1;
  int32 page = 2;
  int32 limit = 3;
  PaymentStatus status_filter = 4;
  PaymentMethod method_filter = 5;
  google.protobuf.Timestamp from_date = 6;
  google.protobuf.Timestamp to_date = 7;
}

message ListPaymentsResponse {
  repeated PaymentResponse payments = 1;
  int32 total = 2;
  int32 page = 3;
  int32 limit = 4;
  int32 total_pages = 5;
}

message PaymentResponse {
  string id = 1;
  string user_id = 2;
  double amount = 3;
  string currency = 4;
  PaymentStatus status = 5;
  PaymentMethod method = 6;
  string transaction_id = 7;
  string subscription_id = 8;
  string description = 9;
  google.protobuf.Struct metadata = 10;
  google.protobuf.Timestamp processed_at = 11;
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
}

message CreateSubscriptionRequest {
  string user_id = 1;
  SubscriptionTier tier = 2;
  string payment_method_id = 3;
  bool auto_renew = 4;
  google.protobuf.Struct metadata = 5;
}

message UpdateSubscriptionRequest {
  string id = 1;
  SubscriptionTier tier = 2;
  string payment_method_id = 3;
  bool cancel_at_period_end = 4;
}

message CancelSubscriptionRequest {
  string id = 1;
  bool immediate = 2;
  string reason = 3;
}

message GetSubscriptionRequest {
  string id = 1;
  string user_id = 2;
}

message ListSubscriptionsRequest {
  string user_id = 1;
  int32 page = 2;
  int32 limit = 3;
  SubscriptionStatus status_filter = 4;
  SubscriptionTier tier_filter = 5;
}

message ListSubscriptionsResponse {
  repeated SubscriptionResponse subscriptions = 1;
  int32 total = 2;
  int32 page = 3;
  int32 limit = 4;
  int32 total_pages = 5;
}

message SubscriptionResponse {
  string id = 1;
  string user_id = 2;
  SubscriptionTier tier = 3;
  SubscriptionStatus status = 4;
  google.protobuf.Timestamp current_period_start = 5;
  google.protobuf.Timestamp current_period_end = 6;
  bool cancel_at_period_end = 7;
  string payment_method_id = 8;
  string last_payment_id = 9;
  google.protobuf.Timestamp next_payment_date = 10;
  google.protobuf.Timestamp created_at = 11;
  google.protobuf.Timestamp updated_at = 12;
}

message ValidatePaymentMethodRequest {
  string user_id = 1;
  PaymentMethod method = 2;
  google.protobuf.Struct payment_details = 3;
}

message ValidatePaymentMethodResponse {
  bool valid = 1;
  string error_message = 2;
  string payment_method_token = 3;
}

// Enums
enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  PAYMENT_STATUS_PENDING = 1;
  PAYMENT_STATUS_PROCESSING = 2;
  PAYMENT_STATUS_COMPLETED = 3;
  PAYMENT_STATUS_FAILED = 4;
  PAYMENT_STATUS_REFUNDED = 5;
  PAYMENT_STATUS_CANCELLED = 6;
}

enum PaymentMethod {
  PAYMENT_METHOD_UNSPECIFIED = 0;
  PAYMENT_METHOD_CARD = 1;
  PAYMENT_METHOD_BANK_TRANSFER = 2;
  PAYMENT_METHOD_CRYPTO = 3;
  PAYMENT_METHOD_PAYPAL = 4;
  PAYMENT_METHOD_STRIPE = 5;
}

enum SubscriptionTier {
  SUBSCRIPTION_TIER_UNSPECIFIED = 0;
  SUBSCRIPTION_TIER_FREE = 1;
  SUBSCRIPTION_TIER_BASIC = 2;
  SUBSCRIPTION_TIER_PREMIUM = 3;
  SUBSCRIPTION_TIER_ENTERPRISE = 4;
}

enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  SUBSCRIPTION_STATUS_ACTIVE = 1;
  SUBSCRIPTION_STATUS_CANCELLED = 2;
  SUBSCRIPTION_STATUS_EXPIRED = 3;
  SUBSCRIPTION_STATUS_PAST_DUE = 4;
}