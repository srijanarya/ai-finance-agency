name: Posting Monitor & Recovery

on:
  schedule:
    # Run every hour to check for missed posts
    - cron: '15 * * * *'  # 15 minutes past every hour
  workflow_dispatch:  # Allow manual trigger

jobs:
  monitor-posts:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Use minimal requirements file for GitHub Actions
        pip install -r requirements-github-actions.txt || {
          echo "Failed to install from requirements file, using full requirements..."
          pip install -r requirements.txt
        }
    
    - name: Check for missed posts
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
      run: |
        python posting_monitor.py
        
        # Check if we're within posting window
        python -c "
        from posting_monitor import PostingMonitor
        import subprocess
        monitor = PostingMonitor()
        missed = monitor.check_missed_posts()
        if missed:
            print(f'⚠️ Found {len(missed)} missed posts. Running recovery...')
            subprocess.run(['python', 'cloud_poster.py'])
            print('✅ Recovery complete!')
        elif monitor.should_post_now():
            print('🔔 Within posting window. Ensuring post...')
            subprocess.run(['python', 'cloud_poster.py'])
        else:
            print('✅ All posts on schedule!')
        "
    
    - name: Commit history updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add posting_history.json 2>/dev/null || true
        git commit -m "Update posting history [skip ci]" 2>/dev/null || true
        git push 2>/dev/null || true